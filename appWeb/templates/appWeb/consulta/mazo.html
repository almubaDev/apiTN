{% extends 'appWeb/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Tarotnaútica{% endblock %}

{% block extra_css %}
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
    .tirada-card {
        transition: all 0.3s ease;
    }

    .tirada-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 25px 50px rgba(139, 92, 246, 0.15);
    }

    .modal {
        transition: all 0.3s ease;
    }

    .modal.show {
        opacity: 1;
        pointer-events: all;
    }

    .modal.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* NUEVO: Estilos para cartas interactivas */
    .carta-resultado {
        transition: all 0.3s ease;
        cursor: pointer;
        perspective: 1000px;
    }

    .carta-resultado:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px rgba(139, 92, 246, 0.3);
    }

    .carta-flip-container {
        position: relative;
        width: 100%;
        height: 200px;
        transition: transform 0.6s;
        transform-style: preserve-3d;
    }

    .carta-flip-container.flipped {
        transform: rotateY(180deg);
    }

    .carta-front, .carta-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 8px;
        overflow: hidden;
    }

    .carta-back {
        transform: rotateY(180deg);
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(217, 70, 239, 0.2) 100%);
        padding: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    /* Estilos para las cartas del resultado */
    .carta-resultado .carta-imagen-container {
        aspect-ratio: 2/3;
        height: 200px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(217, 70, 239, 0.1) 100%);
        border-radius: 8px;
        padding: 8px;
        overflow: hidden;
    }

    .carta-resultado img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 6px;
    }

    /* Estilos para el contenido markdown - SIN limitaciones de altura */
    .interpretacion-content {
        line-height: 1.8;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .interpretacion-content h1,
    .interpretacion-content h2,
    .interpretacion-content h3,
    .interpretacion-content h4 {
        color: #e0d4f7;
        font-weight: 600;
        margin: 1.5rem 0 1rem 0;
        font-family: 'Cinzel', serif;
    }

    .interpretacion-content h1 {
        font-size: 1.5rem;
        border-bottom: 2px solid #8b5cf6;
        padding-bottom: 0.5rem;
    }

    .interpretacion-content h2 {
        font-size: 1.3rem;
        color: #c4b5fd;
    }

    .interpretacion-content h3 {
        font-size: 1.2rem;
        color: #ddd6fe;
    }

    .interpretacion-content h4 {
        font-size: 1.1rem;
        color: #e0d4f7;
    }

    .interpretacion-content p {
        margin: 1rem 0;
        color: #cbd5e1;
    }

    .interpretacion-content strong {
        color: #fbbf24;
        font-weight: 600;
    }

    .interpretacion-content em {
        color: #d946ef;
        font-style: italic;
    }

    .interpretacion-content ul,
    .interpretacion-content ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
        color: #cbd5e1;
    }

    .interpretacion-content li {
        margin: 0.5rem 0;
    }

    .interpretacion-content blockquote {
        border-left: 4px solid #8b5cf6;
        padding-left: 1rem;
        margin: 1.5rem 0;
        background: rgba(139, 92, 246, 0.1);
        border-radius: 0 8px 8px 0;
        padding: 1rem;
        font-style: italic;
        color: #e0d4f7;
    }

    .interpretacion-content code {
        background: rgba(139, 92, 246, 0.2);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        color: #e0d4f7;
    }

    .interpretacion-content pre {
        background: rgba(15, 23, 42, 0.8);
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1rem 0;
        border: 1px solid #334155;
    }

    /* Estilos para emojis */
    .interpretacion-content .emoji {
        font-size: 1.2em;
        margin: 0 0.2rem;
    }

    /* NUEVO: Tooltip para instrucciones de carta */
    .carta-tooltip {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(139, 92, 246, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
        z-index: 10;
    }

    .carta-resultado:hover .carta-tooltip {
        opacity: 1;
    }

    /* NUEVO: Modal de carta individual */
    .modal-carta {
        backdrop-filter: blur(8px);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-cosmic-900 via-cosmic-800 to-primary-900/20">

    <!-- Lista de Tiradas -->
    <div class="pb-20">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

            <!-- Section Header -->
            <div class="text-center mb-12">
                <h2 class="font-mystical text-3xl font-bold text-cosmic-100 mb-4">
                    <i class="fas fa-cards mr-3 text-primary-400"></i>
                    Selecciona tu Tirada Mística
                </h2>
                <p class="text-cosmic-300 max-w-2xl mx-auto">
                    Cada tirada revela diferentes aspectos de tu destino. Elige la que resuene con tu pregunta.
                </p>
            </div>

            <!-- Grid de Tiradas -->
            {% if mazo.tiradas %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                {% for tirada in mazo.tiradas %}
                <div class="tirada-card bg-cosmic-800/80 backdrop-blur-sm rounded-xl border border-cosmic-600 overflow-hidden hover:border-primary-500/50">

                    <!-- Imagen de la Tirada -->
                    {% if tirada.imagen %}
                    <div class="aspect-[4/3] bg-cosmic-700 overflow-hidden">
                        <img src="{{ tirada.imagen }}"
                             alt="{{ tirada.nombre }}"
                             class="w-full h-full object-cover">
                    </div>
                    {% else %}
                    <div class="aspect-[4/3] bg-gradient-to-br from-cosmic-700 to-cosmic-800 flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-cards text-4xl text-primary-400 mb-3"></i>
                            <p class="text-cosmic-300 text-sm">{{ tirada.nombre }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Contenido de la Tirada -->
                    <div class="p-4">
                        <div class="flex flex-col h-full items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="font-mystical text-xl font-semibold text-cosmic-100 mb-2">
                                    {{ tirada.nombre }}
                                </h3>
                                <div class="flex items-center text-sm text-cosmic-400 mb-3">
                                    <i class="fas fa-layer-group mr-2"></i>
                                    <span>{{ tirada.cantidad_cartas }} carta{{ tirada.cantidad_cartas|pluralize }}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0">
                                <i class="fas fa-coins text-gold-400"></i>
                                <span class="text-xl font-bold text-gold-400">{{ tirada.costo }}</span>
                            </div>
                        </div>

                        <!-- Descripción -->
                        <p class="text-cosmic-300 text-sm leading-relaxed mb-6">
                            {{ tirada.descripcion }}
                        </p>

                        <!-- Botón de Realizar Tirada -->
                        <button onclick="iniciarConsulta({{ tirada.id }}, '{{ tirada.nombre|escapejs }}', {{ tirada.costo }}, '{% if tirada.imagen %}{{ tirada.imagen.url|escapejs }}{% endif %}')"
                                class="mt-auto w-full bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                            <i class="fas fa-magic mr-2"></i>
                            Realizar tirada por {{ tirada.costo }} crédito{{ tirada.costo|pluralize }}
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-16">
                <div class="w-24 h-24 bg-cosmic-700/50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-cards text-3xl text-cosmic-400"></i>
                </div>
                <h3 class="font-mystical text-xl text-cosmic-200 mb-2">No hay tiradas disponibles</h3>
                <p class="text-cosmic-400">Este mazo aún no tiene tiradas configuradas.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal: Créditos Insuficientes -->
<div id="modalCreditosInsuficientes" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-cosmic-800 rounded-2xl border border-red-500/30 max-w-md w-full">
        <div class="p-6 text-center">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-coins text-3xl text-red-400"></i>
            </div>
            <h3 class="font-mystical text-xl font-bold text-cosmic-100 mb-2">
                Créditos Insuficientes
            </h3>
            <p class="text-cosmic-300 mb-4">
                Necesitas <span id="creditosNecesarios" class="text-gold-400 font-bold"></span> créditos para esta tirada.
                <br>Actualmente tienes <span id="creditosActuales" class="text-gold-400 font-bold"></span> créditos.
            </p>
            <div class="flex gap-3">
                <button onclick="cerrarModal('modalCreditosInsuficientes')"
                        class="flex-1 border border-cosmic-500 text-cosmic-300 py-3 rounded-lg font-medium hover:bg-cosmic-700 transition-colors">
                    Cancelar
                </button>
                <a href="{% url 'appWeb:comprar_creditos' %}"
                   class="flex-1 bg-gradient-to-r from-gold-500 to-primary-500 hover:from-gold-600 hover:to-primary-600 text-white py-3 rounded-lg font-medium text-center transition-all">
                    <i class="fas fa-plus mr-2"></i>Comprar Créditos
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Formulario de Consulta -->
<div id="modalConsulta" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-cosmic-800 rounded-2xl border border-cosmic-600 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-cosmic-700">
            <div class="flex items-center justify-between">
                <h3 class="font-mystical text-xl font-bold text-cosmic-100">
                    <i class="fas fa-magic mr-3 text-primary-400"></i>
                    Realizar Consulta
                </h3>
                <button onclick="cerrarModal('modalConsulta')" class="text-cosmic-400 hover:text-cosmic-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <p class="text-cosmic-300 mt-2">
                Tirada: <span id="tiradaNombre" class="text-primary-400 font-medium"></span> -
                Costo: <span id="tiradaCosto" class="text-gold-400 font-bold"></span> créditos
            </p>
        </div>

        <div class="p-6">
            <form id="formConsulta">
                {% csrf_token %}
                <div class="mb-6">
                    <label class="block text-sm font-medium text-cosmic-200 mb-3">
                        <i class="fas fa-question-circle mr-2 text-mystic-400"></i>
                        Escribe tu pregunta al universo
                    </label>
                    <textarea id="preguntaConsulta"
                              name="pregunta"
                              required
                              maxlength="500"
                              rows="4"
                              class="w-full px-4 py-3 bg-cosmic-900 border border-cosmic-600 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent text-cosmic-100 placeholder-cosmic-400 resize-none"
                              placeholder="¿Qué deseas saber? Sé específico en tu consulta..."></textarea>
                    <div class="flex justify-between mt-2">
                        <p class="text-cosmic-500 text-xs">Máximo 500 caracteres</p>
                        <p class="text-cosmic-500 text-xs">
                            <span id="contadorCaracteres">0</span>/500
                        </p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="cerrarModal('modalConsulta')"
                            class="flex-1 border border-cosmic-500 text-cosmic-300 py-3 rounded-lg font-medium hover:bg-cosmic-700 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit"
                            class="flex-1 bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white py-3 rounded-lg font-medium transition-all">
                        <i class="fas fa-crystal-ball mr-2"></i>
                        Consultar al Oráculo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Loading y Resultado - CORREGIDO: Altura adaptativa -->
<div id="modalResultado" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-cosmic-800 rounded-2xl border border-cosmic-600 w-full max-w-6xl max-h-[95vh] min-h-[400px] flex flex-col overflow-hidden">

        <!-- Loading State -->
        <div id="loadingState" class="p-8 text-center">
            <div class="mb-6">
                <img id="tiradaImagen" src="" alt="" class="w-32 h-32 object-cover rounded-lg mx-auto mb-4" style="display: none;">
                <div class="loading-spinner w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            </div>
            <h3 class="font-mystical text-xl font-bold text-cosmic-100 mb-2">
                Consultando al Oráculo...
            </h3>
            <p class="text-cosmic-300">
                Las energías cósmicas están alineándose para revelarte tu destino
            </p>
        </div>

        <!-- Resultado State -->
        <div id="resultadoState" class="hidden flex flex-col min-h-0">
            <!-- Header - FIJO -->
            <div class="flex-shrink-0 p-6 border-b border-cosmic-700">
                <div class="flex items-center justify-between">
                    <h3 class="font-mystical text-2xl font-bold text-cosmic-100">
                        <i class="fas fa-eye mr-3 text-gold-400"></i>
                        Tu Destino Revelado
                    </h3>
                    <button onclick="cerrarModal('modalResultado')" class="text-cosmic-400 hover:text-cosmic-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Contenido del Resultado - SCROLLEABLE ADAPTATIVO -->
            <div class="flex-1 overflow-y-auto p-6 space-y-6">

                <!-- Pregunta del Consultante -->
                <div class="bg-primary-900/20 border border-primary-500/30 rounded-lg p-4">
                    <h4 class="font-mystical text-lg font-semibold text-primary-300 mb-2">
                        <i class="fas fa-question-circle mr-2"></i>
                        Tu Pregunta
                    </h4>
                    <p id="preguntaResultado" class="text-cosmic-200 italic"></p>
                </div>

                <!-- Cartas Reveladas - NUEVO: Con funcionalidad de volteo -->
                <div>
                    <h4 class="font-mystical text-lg font-semibold text-cosmic-100 mb-4">
                        <i class="fas fa-cards mr-2 text-gold-400"></i>
                        Cartas Reveladas
                        <span class="text-sm text-cosmic-400 font-normal ml-2">(Toca una carta para ver su significado)</span>
                    </h4>
                    <div id="cartasGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Las cartas se llenarán dinámicamente -->
                    </div>
                </div>

                <!-- Interpretación de la IA -->
                <div class="bg-cosmic-700/30 rounded-lg p-6 border border-cosmic-600">
                    <h4 class="font-mystical text-lg font-semibold text-cosmic-100 mb-4">
                        <i class="fas fa-crystal-ball mr-2 text-mystic-400"></i>
                        Interpretación Mística
                    </h4>
                    <div id="interpretacionIA" class="interpretacion-content text-cosmic-200 leading-relaxed">
                        <!-- El contenido se llenará con JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Footer - FIJO -->
            <div class="flex-shrink-0 p-6 border-t border-cosmic-700">
                <div class="flex gap-3">
                    <button onclick="cerrarModal('modalResultado')"
                            class="flex-1 bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white py-3 rounded-lg font-medium transition-all">
                        <i class="fas fa-check mr-2"></i>
                        Entendido
                    </button>
                    <a href="{% url 'appWeb:historial_consultas' %}"
                       class="flex-1 border border-cosmic-500 text-cosmic-300 hover:text-cosmic-100 py-3 rounded-lg font-medium text-center transition-colors">
                        <i class="fas fa-history mr-2"></i>
                        Ver Historial
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NUEVO: Modal para significado individual de carta - CORREGIDO -->
<div id="modalCarta" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4 modal-carta">
    <div class="bg-cosmic-800 rounded-2xl border border-cosmic-600 max-w-lg w-full max-h-[85vh] overflow-y-auto">
        <div class="p-6 border-b border-cosmic-700">
            <div class="flex items-center justify-between">
                <h3 class="font-mystical text-xl font-bold text-cosmic-100" id="cartaModalTitulo">
                    <i class="fas fa-scroll mr-2 text-gold-400"></i>
                    Conoce tu Carta
                </h3>
                <button onclick="cerrarModal('modalCarta')" class="text-cosmic-400 hover:text-cosmic-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="p-6">
            <!-- Imagen de la carta -->
            <div class="text-center mb-6">
                <div class="w-32 h-48 mx-auto mb-3 rounded-lg overflow-hidden bg-cosmic-700 border border-cosmic-600">
                    <img id="cartaModalImagen" src="" alt="" class="w-full h-full object-contain">
                </div>
                <h4 id="cartaModalNombre" class="font-mystical text-lg font-semibold text-cosmic-100 mb-1"></h4>
                <p id="cartaModalPosicion" class="text-cosmic-400 text-sm mb-3"></p>
                
                <!-- Orientación en la tirada -->
                <div id="cartaModalOrientacion" class="inline-flex items-center px-3 py-1 rounded-full text-sm mb-4">
                    <i class="fas fa-arrow-up mr-2"></i>
                    <span>Derecha</span>
                </div>
            </div>

            <!-- CORREGIDO: Área para mostrar ambos significados -->
            <div class="space-y-4">
                <h5 class="font-semibold text-cosmic-200 text-center">
                    <i class="fas fa-book-open mr-2 text-mystic-400"></i>
                    Significados de esta Carta:
                </h5>
                <div id="cartaModalSignificado" class="space-y-4">
                    <!-- Los significados se llenarán con JavaScript -->
                </div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="cerrarModal('modalCarta')" 
                        class="bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white px-6 py-3 rounded-lg font-medium transition-all">
                    <i class="fas fa-check mr-2"></i>Entendido
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Variables globales
var tiradaSeleccionada = {
    id: null,
    nombre: '',
    costo: 0,
    imagen: ''
};

var cartasResultadoGlobal = []; // NUEVO: Para almacenar datos completos de las cartas

// Función para procesar markdown
function parseMarkdown(text) {
    // Procesar títulos
    text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
    text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
    text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');

    // Procesar negritas
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

    // Procesar cursivas
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

    // Procesar saltos de línea dobles como párrafos
    text = text.replace(/\n\n/g, '</p><p>');
    text = '<p>' + text + '</p>';

    // Limpiar párrafos vacíos
    text = text.replace(/<p><\/p>/g, '');
    text = text.replace(/<p>\s*<\/p>/g, '');

    // Procesar listas
    text = text.replace(/^\- (.*$)/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');

    // Procesar saltos de línea simples
    text = text.replace(/\n/g, '<br>');

    return text;
}

// Función para obtener CSRF token
function getCSRFToken() {
    var metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }

    var inputToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (inputToken) {
        return inputToken.value;
    }

    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
            return cookie.substring('csrftoken='.length);
        }
    }

    console.error('CSRF token no encontrado');
    return null;
}

// CORREGIDO: Función para mostrar modal de carta individual con significados reales
function mostrarModalCarta(cartaIndex) {
    if (!cartasResultadoGlobal[cartaIndex]) {
        console.error('Carta no encontrada:', cartaIndex);
        return;
    }

    var cartaInfo = cartasResultadoGlobal[cartaIndex];
    var carta = cartaInfo.carta;

    // Llenar información del modal
    document.getElementById('cartaModalNombre').textContent = carta.nombre || 'Carta Desconocida';
    document.getElementById('cartaModalPosicion').textContent = cartaInfo.posicion || '';
    document.getElementById('cartaModalImagen').src = carta.imagen || '';
    document.getElementById('cartaModalImagen').alt = carta.nombre || '';

    // CORREGIDO: Mostrar ambos significados (normal e invertida) de la carta
    var significadoHTML = '';
    
    // Significado normal (siempre se muestra)
    if (carta.significado_normal) {
        significadoHTML += '<div class="mb-4">';
        significadoHTML += '<h6 class="font-semibold text-green-400 mb-2 flex items-center">';
        significadoHTML += '<i class="fas fa-arrow-up mr-2"></i>Significado Derecho:';
        significadoHTML += '</h6>';
        significadoHTML += '<p class="text-cosmic-300 text-sm leading-relaxed">' + carta.significado_normal + '</p>';
        significadoHTML += '</div>';
    }
    
    // Significado invertido (solo si existe)
    if (carta.significado_invertida && carta.significado_invertida.trim() !== '') {
        significadoHTML += '<div class="mb-4">';
        significadoHTML += '<h6 class="font-semibold text-orange-400 mb-2 flex items-center">';
        significadoHTML += '<i class="fas fa-undo mr-2"></i>Significado Invertido:';
        significadoHTML += '</h6>';
        significadoHTML += '<p class="text-cosmic-300 text-sm leading-relaxed">' + carta.significado_invertida + '</p>';
        significadoHTML += '</div>';
    }
    
    // Si no hay significados, mostrar mensaje
    if (!significadoHTML) {
        significadoHTML = '<p class="text-cosmic-400 text-sm">No hay significados disponibles para esta carta.</p>';
    }
    
    document.getElementById('cartaModalSignificado').innerHTML = significadoHTML;

    // Configurar orientación actual de la carta en la tirada
    var orientacionElement = document.getElementById('cartaModalOrientacion');
    if (cartaInfo.es_invertida) {
        orientacionElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-orange-500/20 text-orange-300';
        orientacionElement.innerHTML = '<i class="fas fa-undo mr-2"></i><span>Salió Invertida en tu tirada</span>';
    } else {
        orientacionElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-500/20 text-green-300';
        orientacionElement.innerHTML = '<i class="fas fa-arrow-up mr-2"></i><span>Salió Derecha en tu tirada</span>';
    }

    mostrarModal('modalCarta');
}

// Inicializar eventos cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM cargado');

    // Contador de caracteres
    var textarea = document.getElementById('preguntaConsulta');
    var contador = document.getElementById('contadorCaracteres');

    if (textarea && contador) {
        textarea.addEventListener('input', function() {
            contador.textContent = this.value.length;
        });
    }

    // Formulario de consulta
    var form = document.getElementById('formConsulta');
    if (form) {
        form.addEventListener('submit', realizarConsulta);
    }
});

// Iniciar proceso de consulta
function iniciarConsulta(tiradaId, tiradaNombre, tiradaCosto, tiradaImagen) {
    console.log('Iniciando consulta:', tiradaId, tiradaNombre, tiradaCosto);

    // Actualizar variable global
    tiradaSeleccionada = {
        id: tiradaId,
        nombre: tiradaNombre,
        costo: tiradaCosto,
        imagen: tiradaImagen || ''
    };

    // Ir directamente al modal de consulta
    document.getElementById('tiradaNombre').textContent = tiradaNombre;
    document.getElementById('tiradaCosto').textContent = tiradaCosto;

    var preguntaInput = document.getElementById('preguntaConsulta');
    var contadorElement = document.getElementById('contadorCaracteres');

    if (preguntaInput) preguntaInput.value = '';
    if (contadorElement) contadorElement.textContent = '0';

    mostrarModal('modalConsulta');
}

// Realizar consulta
function realizarConsulta(e) {
    e.preventDefault();
    console.log('Realizando consulta...');

    var preguntaElement = document.getElementById('preguntaConsulta');
    if (!preguntaElement) {
        console.error('Elemento preguntaConsulta no encontrado');
        alert('Error: No se puede obtener la pregunta');
        return;
    }

    var pregunta = preguntaElement.value.trim();
    console.log('Pregunta:', pregunta);

    if (!pregunta) {
        alert('Por favor escribe tu pregunta');
        return;
    }

    if (!tiradaSeleccionada.id) {
        console.error('No hay tirada seleccionada');
        alert('Error: No hay tirada seleccionada');
        return;
    }

    // Cerrar modal de consulta y mostrar loading
    cerrarModal('modalConsulta');
    mostrarModalResultado();

    // Configurar imagen de tirada en loading
    var tiradaImg = document.getElementById('tiradaImagen');
    if (tiradaImg) {
        if (tiradaSeleccionada.imagen) {
            tiradaImg.src = tiradaSeleccionada.imagen;
            tiradaImg.style.display = 'block';
        } else {
            tiradaImg.style.display = 'none';
        }
    }

    // Obtener CSRF token
    var csrfToken = getCSRFToken();
    if (!csrfToken) {
        alert('Error: Token de seguridad no encontrado');
        cerrarModal('modalResultado');
        return;
    }

    console.log('Enviando datos:', {
        tirada_id: tiradaSeleccionada.id,
        pregunta: pregunta
    });

    // Realizar llamada AJAX
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({
            'tirada_id': tiradaSeleccionada.id,
            'pregunta': pregunta
        })
    })
    .then(function(response) {
        console.log('Respuesta recibida:', response.status);
        if (!response.ok) {
            throw new Error('Error HTTP: ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        console.log('Datos recibidos:', data);

        if (data.success) {
            mostrarResultado(data.resultado, pregunta);
            // Actualizar créditos en la UI
            var creditosElement = document.getElementById('creditos-display') || document.getElementById('creditos-display-mobile');
            if (creditosElement) {
                creditosElement.textContent = data.creditos_restantes || 0;
            }
        } else {
            console.error('Error en la respuesta:', data.error);
            if (data.error === 'creditos_insuficientes') {
                cerrarModal('modalResultado');
                document.getElementById('creditosNecesarios').textContent = data.creditos_necesarios || 0;
                document.getElementById('creditosActuales').textContent = data.creditos_disponibles || 0;
                mostrarModal('modalCreditosInsuficientes');
            } else {
                alert('Error: ' + (data.error || 'Error desconocido'));
                cerrarModal('modalResultado');
            }
        }
    })
    .catch(function(error) {
        console.error('Error completo:', error);
        alert('Error de conexión: ' + error.message);
        cerrarModal('modalResultado');
    });
}

// ACTUALIZADO: Mostrar resultado con cartas interactivas
function mostrarResultado(resultado, pregunta) {
    console.log('Mostrando resultado:', resultado);

    // Ocultar loading y mostrar resultado
    var loadingState = document.getElementById('loadingState');
    var resultadoState = document.getElementById('resultadoState');

    if (loadingState) loadingState.style.display = 'none';
    if (resultadoState) resultadoState.classList.remove('hidden');

    // Llenar pregunta
    var preguntaElement = document.getElementById('preguntaResultado');
    if (preguntaElement) preguntaElement.textContent = pregunta;

    // Llenar interpretación con procesamiento de markdown
    var interpretacionElement = document.getElementById('interpretacionIA');
    if (interpretacionElement) {
        var interpretacionTexto = resultado.interpretacion_ia || 'Sin interpretación disponible';
        interpretacionElement.innerHTML = parseMarkdown(interpretacionTexto);
    }

    // NUEVO: Almacenar cartas globalmente para modal individual
    cartasResultadoGlobal = resultado.cartas || [];

    // ACTUALIZADO: Llenar cartas con funcionalidad interactiva
    var cartasGrid = document.getElementById('cartasGrid');
    if (cartasGrid) {
        cartasGrid.innerHTML = '';

        var cartas = resultado.cartas || [];
        for (var i = 0; i < cartas.length; i++) {
            var cartaInfo = cartas[i];
            var cartaDiv = document.createElement('div');
            cartaDiv.className = 'carta-resultado bg-cosmic-700/50 rounded-lg border border-cosmic-600 overflow-hidden relative';
            
            // NUEVO: Agregar atributo onclick para mostrar modal
            cartaDiv.setAttribute('onclick', 'mostrarModalCarta(' + i + ')');

            var rotacionClass = cartaInfo.es_invertida ? 'transform rotate-180' : '';
            var badgeClass = cartaInfo.es_invertida ? 'bg-orange-500/20 text-orange-300' : 'bg-green-500/20 text-green-300';
            var iconClass = cartaInfo.es_invertida ? 'undo' : 'arrow-up';
            var orientacionTexto = cartaInfo.es_invertida ? 'Invertida' : 'Derecha';

            cartaDiv.innerHTML =
                '<div class="carta-tooltip">Toca para ver significado</div>' +
                '<div class="carta-imagen-container">' +
                    '<img src="' + (cartaInfo.carta.imagen || '') + '" ' +
                         'alt="' + (cartaInfo.carta.nombre || '') + '" ' +
                         'class="' + rotacionClass + '">' +
                '</div>' +
                '<div class="p-4">' +
                    '<h5 class="font-mystical font-semibold text-cosmic-100 mb-1">' + (cartaInfo.posicion || '') + '</h5>' +
                    '<p class="text-cosmic-300 text-sm mb-2">' + (cartaInfo.carta.nombre || '') + '</p>' +
                    '<div class="flex items-center mb-2">' +
                        '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs ' + badgeClass + '">' +
                            '<i class="fas fa-' + iconClass + ' mr-1"></i>' +
                            orientacionTexto +
                        '</span>' +
                    '</div>' +
                    '<p class="text-cosmic-400 text-xs leading-relaxed">' + (cartaInfo.descripcion_posicion || '') + '</p>' +
                '</div>';

            cartasGrid.appendChild(cartaDiv);
        }
    }
}

// Funciones de modal
function mostrarModal(modalId) {
    console.log('Mostrando modal:', modalId);
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.classList.add('overflow-hidden');
    }
}

function cerrarModal(modalId) {
    console.log('Cerrando modal:', modalId);
    var modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('show');
        document.body.classList.remove('overflow-hidden');
    }
}

function mostrarModalResultado() {
    // Reset states
    var loadingState = document.getElementById('loadingState');
    var resultadoState = document.getElementById('resultadoState');

    if (loadingState) loadingState.style.display = 'block';
    if (resultadoState) resultadoState.classList.add('hidden');

    mostrarModal('modalResultado');
}

// Cerrar modal al hacer clic fuera
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        var modalId = e.target.id;
        cerrarModal(modalId);
    }
});

// Cerrar modal con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var modals = ['modalCreditosInsuficientes', 'modalConsulta', 'modalResultado', 'modalCarta'];
        for (var i = 0; i < modals.length; i++) {
            var modal = document.getElementById(modals[i]);
            if (modal && !modal.classList.contains('hidden')) {
                cerrarModal(modals[i]);
                break;
            }
        }
    }
});
</script>
{% endblock %}