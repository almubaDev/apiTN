{% extends 'appWeb/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Tarotnaútica{% endblock %}

{% block extra_css %}
<style>
    .filter-sidebar {
        transition: transform 0.3s ease-in-out;
    }
    
    .filter-sidebar.hidden-mobile {
        transform: translateX(-100%);
    }
    
    @media (min-width: 768px) {
        .filter-sidebar.hidden-mobile {
            transform: translateX(0);
        }
    }
    
    .mazo-card {
        transition: all 0.3s ease;
    }
    
    .mazo-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 25px 50px rgba(139, 92, 246, 0.15);
    }
    
    .overlay-gradient {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(217, 70, 239, 0.1) 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-cosmic-900 via-cosmic-800 to-primary-900/20">
    
    <!-- Header -->
    <div class="pt-20 pb-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h1 class="font-mystical text-3xl md:text-5xl font-bold text-cosmic-100 mb-4">
                    <i class="fas fa-magic mr-3 text-primary-400"></i>
                    Mazos Místicos
                </h1>
                <p class="text-lg text-cosmic-300 max-w-2xl mx-auto">
                    Explora nuestra colección de mazos sagrados, cada uno con su propia energía y sabiduría ancestral
                </p>
            </div>
            
            <!-- Mobile Filter Toggle -->
            <div class="md:hidden mb-6 flex justify-between items-center">
                <div class="text-cosmic-200">
                    <span class="text-sm">{{ mazos|length }} mazo{{ mazos|length|pluralize }} encontrado{{ mazos|length|pluralize }}</span>
                </div>
                <button id="toggleFilters" 
                        class="flex items-center space-x-2 bg-cosmic-800 text-cosmic-200 px-4 py-2 rounded-lg border border-cosmic-600 hover:border-primary-500 transition-colors">
                    <i class="fas fa-filter"></i>
                    <span>Filtros</span>
                    <i class="fas fa-chevron-down transform transition-transform" id="filterChevron"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
        <div class="flex flex-col md:flex-row gap-8">
            
            <!-- Sidebar de Filtros -->
            <div class="md:w-80 flex-shrink-0">
                <div id="filterSidebar" class="filter-sidebar hidden-mobile md:transform-none bg-cosmic-800/80 backdrop-blur-sm rounded-xl border border-cosmic-600 overflow-hidden">
                    
                    <!-- Sidebar Header -->
                    <div class="p-6 border-b border-cosmic-700">
                        <div class="flex items-center justify-between">
                            <h3 class="font-mystical text-xl font-semibold text-cosmic-100">
                                <i class="fas fa-stream mr-2 text-primary-400"></i>
                                Filtrar por Sets
                            </h3>
                            <button class="md:hidden text-cosmic-400 hover:text-cosmic-200" onclick="toggleMobileFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-cosmic-400 text-sm mt-2">Selecciona los sets que quieres explorar</p>
                    </div>
                    
                    <!-- Filtros por Sets -->
                    <div class="p-6">
                        <form method="GET" id="filterForm">
                            
                            <!-- Botones de Control -->
                            <div class="flex gap-2 mb-4">
                                <button type="button" onclick="selectAllSets()" 
                                        class="flex-1 text-xs bg-primary-500/20 text-primary-300 px-3 py-2 rounded-lg hover:bg-primary-500/30 transition-colors">
                                    <i class="fas fa-check-double mr-1"></i>
                                    Todos
                                </button>
                                <button type="button" onclick="clearAllSets()" 
                                        class="flex-1 text-xs bg-cosmic-700 text-cosmic-300 px-3 py-2 rounded-lg hover:bg-cosmic-600 transition-colors">
                                    <i class="fas fa-times mr-1"></i>
                                    Limpiar
                                </button>
                            </div>
                            
                            <!-- Lista de Sets -->
                            <div class="space-y-3">
                                {% for set in sets %}
                                <label class="flex items-start space-x-3 p-3 rounded-lg hover:bg-cosmic-700/50 transition-colors cursor-pointer group">
                                    <input type="checkbox" 
                                           name="sets" 
                                           value="{{ set.id }}" 
                                           {% if set.id|stringformat:"s" in selected_sets %}checked{% endif %}
                                           onchange="updateFilters()"
                                           class="mt-1 rounded bg-cosmic-700 border-cosmic-600 text-primary-500 focus:ring-primary-500 focus:ring-offset-cosmic-800">
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-medium text-cosmic-100 group-hover:text-primary-300 transition-colors">
                                            {{ set.nombre }}
                                        </h4>
                                        <p class="text-xs text-cosmic-400 mt-1">
                                            {{ set.descripcion }}
                                        </p>
                                    </div>
                                </label>
                                {% empty %}
                                <div class="text-center py-4 text-cosmic-400">
                                    <i class="fas fa-search text-2xl mb-2"></i>
                                    <p>No hay sets disponibles</p>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Botón de Aplicar (solo mobile) -->
                            <div class="md:hidden mt-6 pt-4 border-t border-cosmic-700">
                                <button type="button" onclick="applyFiltersAndClose()" 
                                        class="w-full bg-gradient-to-r from-primary-500 to-mystic-500 text-white py-3 rounded-lg font-medium">
                                    <i class="fas fa-check mr-2"></i>
                                    Aplicar Filtros
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Contenido Principal -->
            <div class="flex-1 min-w-0">
                
                <!-- Resultados Header -->
                <div class="hidden md:flex items-center justify-between mb-6">
                    <div class="text-cosmic-200">
                        <span class="text-lg font-medium">{{ mazos|length }} mazo{{ mazos|length|pluralize }} disponible{{ mazos|length|pluralize }}</span>
                        {% if selected_sets %}
                        <div class="flex flex-wrap gap-2 mt-2">
                            {% for set in sets %}
                                {% if set.id|stringformat:"s" in selected_sets %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs bg-primary-500/20 text-primary-300 border border-primary-500/30">
                                    {{ set.nombre }}
                                    <button type="button" onclick="removeSetFilter('{{ set.id }}')" class="ml-2 hover:text-primary-100">
                                        <i class="fas fa-times text-xs"></i>
                                    </button>
                                </span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Lista de Mazos (formato horizontal) -->
                <div class="space-y-6">
                    {% for mazo in mazos %}
                    <div class="mazo-card bg-cosmic-800/80 backdrop-blur-sm rounded-xl border border-cosmic-600 overflow-hidden hover:border-primary-500/50 transition-all duration-300 w-full">
                        
                        <!-- Layout Horizontal: 3 Columnas -->
                        <div class="flex flex-col md:flex-row items-stretch">
                            
                            <!-- Columna 1: Imagen de Carta -->
                            <div class="md:w-32 flex-shrink-0 relative overflow-hidden">
                                <div class="aspect-[2/3] md:h-40 bg-gradient-to-br from-primary-500/20 to-mystic-500/20 flex items-center justify-center">
                                    {% if mazo.carta_aleatoria %}
                                        <!-- Imagen real de la carta -->
                                        <img src="{{ mazo.carta_aleatoria.imagen }}" 
                                             alt="{{ mazo.carta_aleatoria.nombre }}"
                                             class="w-full h-full object-contain carta-imagen"
                                             oncontextmenu="return false;"
                                             draggable="false">
                                    {% else %}
                                        <!-- Imagen placeholder con patrón místico -->
                                        <div class="w-full h-full bg-gradient-to-br from-cosmic-700 to-cosmic-800 flex items-center justify-center relative">
                                            <div class="absolute inset-0 bg-gradient-to-br from-primary-500/10 to-mystic-500/10"></div>
                                            <div class="relative z-10 text-center">
                                                <i class="fas fa-magic text-2xl text-primary-400 mb-2"></i>
                                                <div class="text-xs text-cosmic-300 font-medium">{{ mazo.nombre|truncatewords:2 }}</div>
                                            </div>
                                            <!-- Patrón decorativo -->
                                            <div class="absolute top-2 left-2 w-3 h-3 border border-gold-400/30 rounded-full"></div>
                                            <div class="absolute bottom-2 right-2 w-2 h-2 bg-primary-400/30 rounded-full"></div>
                                            <div class="absolute top-1/2 right-2 w-1 h-1 bg-mystic-400/50 rounded-full"></div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Columna 2: Información Principal -->
                            <div class="flex-1 p-6 flex flex-col justify-center">
                                <div class="overlay-gradient">
                                    <!-- Nombre del Mazo -->
                                    <h3 class="font-mystical text-xl font-semibold text-cosmic-100 mb-2 leading-tight">
                                        {{ mazo.nombre }}
                                    </h3>
                                    
                                    <!-- Nombre del Set -->
                                    <div class="flex items-center text-sm text-cosmic-400 mb-3">
                                        <i class="fas fa-layer-group mr-2"></i>
                                        <span>{{ mazo.set_nombre }}</span>
                                    </div>
                                    
                                    <!-- Descripción del Mazo -->
                                    <p class="text-cosmic-300 text-sm leading-relaxed">
                                        {{ mazo.descripcion }}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Columna 3: Características y Acción -->
                            <div class="md:w-64 flex-shrink-0 p-6 flex flex-col justify-center items-end">
                                <div class="w-full space-y-4">
                                    
                                    <!-- Característica de Cartas Invertidas -->
                                    {% if mazo.permite_cartas_invertidas %}
                                    <div class="flex justify-end">
                                        <span class="inline-flex items-center px-3 py-2 rounded-full text-xs bg-green-500/20 text-green-300 border border-green-500/30">
                                            <i class="fas fa-sync-alt mr-2"></i>
                                            Incluye significado de cartas invertidas
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Botón de Acción -->
                                    <div class="flex justify-end">
                                        <a href="{% url 'appWeb:consulta_mazo' mazo.id %}" 
                                           class="inline-flex items-center bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                                            <i class="fas fa-magic mr-2"></i>
                                            Consultar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    
                    <!-- Estado Vacío -->
                    <div class="col-span-full">
                        <div class="text-center py-16">
                            <div class="w-24 h-24 bg-cosmic-700/50 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-search text-3xl text-cosmic-400"></i>
                            </div>
                            <h3 class="font-mystical text-xl text-cosmic-200 mb-2">No se encontraron mazos</h3>
                            <p class="text-cosmic-400 mb-6">
                                {% if selected_sets %}
                                    Intenta cambiar los filtros seleccionados
                                {% else %}
                                    No hay mazos disponibles en este momento
                                {% endif %}
                            </p>
                            {% if selected_sets %}
                            <button onclick="clearAllSets(); updateFilters();" 
                                    class="bg-primary-500 hover:bg-primary-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                <i class="fas fa-refresh mr-2"></i>
                                Limpiar Filtros
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Desactivar clic derecho en imágenes de cartas
document.addEventListener('DOMContentLoaded', function() {
    // Prevenir clic derecho en imágenes de cartas
    document.querySelectorAll('.carta-imagen').forEach(function(img) {
        img.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Prevenir drag
        img.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
    });
});

let filterSidebar = null;
let filterForm = null;

document.addEventListener('DOMContentLoaded', function() {
    filterSidebar = document.getElementById('filterSidebar');
    filterForm = document.getElementById('filterForm');
    
    // Setup mobile filter toggle
    const toggleBtn = document.getElementById('toggleFilters');
    if (toggleBtn) {
        toggleBtn.addEventListener('click', toggleMobileFilters);
    }
});

function toggleMobileFilters() {
    const chevron = document.getElementById('filterChevron');
    
    if (filterSidebar.classList.contains('hidden-mobile')) {
        // Mostrar
        filterSidebar.classList.remove('hidden-mobile');
        if (chevron) chevron.classList.add('rotate-180');
    } else {
        // Ocultar
        filterSidebar.classList.add('hidden-mobile');
        if (chevron) chevron.classList.remove('rotate-180');
    }
}

function updateFilters() {
    // En desktop, actualizar automáticamente
    if (window.innerWidth >= 768) {
        filterForm.submit();
    }
    // En mobile, esperar a que presione "Aplicar"
}

function applyFiltersAndClose() {
    filterForm.submit();
}

function selectAllSets() {
    const checkboxes = document.querySelectorAll('input[name="sets"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
    });
    updateFilters();
}

function clearAllSets() {
    const checkboxes = document.querySelectorAll('input[name="sets"]');
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    updateFilters();
}

function removeSetFilter(setId) {
    const checkbox = document.querySelector(`input[name="sets"][value="${setId}"]`);
    if (checkbox) {
        checkbox.checked = false;
        updateFilters();
    }
}

// Cerrar filtros al hacer clic fuera (solo mobile)
document.addEventListener('click', function(event) {
    if (window.innerWidth < 768 && filterSidebar && !filterSidebar.classList.contains('hidden-mobile')) {
        if (!filterSidebar.contains(event.target) && !document.getElementById('toggleFilters').contains(event.target)) {
            toggleMobileFilters();
        }
    }
});

// Responsive behavior
window.addEventListener('resize', function() {
    if (window.innerWidth >= 768) {
        // En desktop, asegurar que el sidebar esté visible
        filterSidebar.classList.remove('hidden-mobile');
        const chevron = document.getElementById('filterChevron');
        if (chevron) chevron.classList.remove('rotate-180');
    }
});
</script>
{% endblock %}
{% endblock %}