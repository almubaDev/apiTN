{% extends 'appWeb/base.html' %}
{% load static %}

{% block title %}Pago Exitoso - Tarotnaútica{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-cosmic-900 via-primary-900/30 to-mystic-900/30 py-12 px-4 sm:px-6 lg:px-8">
   <div class="max-w-md w-full space-y-8">
       
       <!-- Loading State (inicial) -->
       <div id="processingState" class="text-center">
           <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-primary-500 rounded-full flex items-center justify-center mx-auto mb-6 relative">
               <i class="fas fa-spinner fa-spin text-3xl text-white" id="processingIcon"></i>
               <!-- Ring animation -->
               <div class="absolute inset-0 rounded-full border-2 border-green-400 animate-ping opacity-30"></div>
           </div>
           <h2 class="font-mystical text-3xl font-bold text-cosmic-100 mb-2">
               Procesando tu Pago...
           </h2>
           <p class="text-cosmic-300">
               Verificando la transacción con la plataforma de pago
           </p>
           <div class="mt-6">
               <div class="animate-pulse text-cosmic-400 text-sm">
                   Esto puede tomar unos segundos...
               </div>
           </div>
       </div>

       <!-- Success State (se muestra después de procesar) -->
       <div id="successState" class="hidden text-center">
           <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-mystic-500 rounded-full flex items-center justify-center mx-auto mb-6 relative">
               <i class="fas fa-check text-3xl text-white" id="checkIcon"></i>
               <div class="absolute inset-0 rounded-full border-2 border-green-400 animate-ping opacity-30"></div>
           </div>
           <h2 class="font-mystical text-3xl font-bold text-cosmic-100 mb-2">
               ¡Pago Exitoso!
           </h2>
           <p class="text-cosmic-300">
               Tus créditos han sido agregados exitosamente
           </p>
       </div>

       <!-- Error State -->
       <div id="errorState" class="hidden text-center">
           <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-orange-500 rounded-full flex items-center justify-center mx-auto mb-6">
               <i class="fas fa-exclamation-triangle text-3xl text-white"></i>
           </div>
           <h2 class="font-mystical text-3xl font-bold text-cosmic-100 mb-2">
               Error en el Pago
           </h2>
           <p class="text-cosmic-300" id="errorMessage">
               Hubo un problema procesando tu pago
           </p>
       </div>

       <!-- Content Card -->
       <div class="bg-cosmic-800/50 backdrop-blur-sm rounded-2xl p-8 border border-cosmic-600 shadow-xl">
           
           <!-- Payment Details -->
           <div id="paymentDetails" class="mb-6">
               <h3 class="font-mystical text-lg font-semibold text-cosmic-100 mb-4">
                   <i class="fas fa-receipt mr-2 text-gold-400"></i>
                   Detalles del Pago
               </h3>
               
               <div class="space-y-3 text-sm">
                   <div class="flex justify-between">
                       <span class="text-cosmic-400">Referencia:</span>
                       <span class="text-cosmic-200 font-mono" id="paymentRef">{{ payment_reference }}</span>
                   </div>
                   <div class="flex justify-between">
                       <span class="text-cosmic-400">Paquete:</span>
                       <span class="text-cosmic-200" id="packageName">-</span>
                   </div>
                   <div class="flex justify-between">
                       <span class="text-cosmic-400">Créditos:</span>
                       <span class="text-gold-400 font-semibold" id="creditsAmount">-</span>
                   </div>
                   <div class="flex justify-between">
                       <span class="text-cosmic-400">Monto:</span>
                       <span class="text-cosmic-200" id="paymentAmount">-</span>
                   </div>
                   <div class="flex justify-between">
                       <span class="text-cosmic-400">Estado:</span>
                       <span id="paymentStatus" class="text-yellow-400">Procesando...</span>
                   </div>
               </div>
           </div>

           <!-- Credits Display -->
           <div id="creditsDisplay" class="hidden mb-6 bg-gold-900/20 border border-gold-500/30 rounded-lg p-4">
               <div class="text-center">
                   <div class="text-2xl font-bold text-gold-400 mb-1">
                       +<span id="newCredits">0</span> créditos
                   </div>
                   <div class="text-cosmic-300 text-sm">
                       Total: <span id="totalCredits">0</span> créditos
                   </div>
               </div>
           </div>

           <!-- Actions -->
           <div id="actionButtons" class="hidden space-y-3">
               <a href="{% url 'appWeb:mazos_list' %}" 
                  class="block w-full bg-gradient-to-r from-primary-500 to-mystic-500 hover:from-primary-600 hover:to-mystic-600 text-white text-center py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105">
                   <i class="fas fa-magic mr-2"></i>Comenzar Consultas
               </a>
               <a href="{% url 'appWeb:perfil' %}" 
                  class="block w-full border-2 border-cosmic-500 text-cosmic-300 hover:text-cosmic-100 hover:border-cosmic-400 text-center py-3 rounded-lg font-medium transition-colors">
                   <i class="fas fa-user mr-2"></i>Ver Mi Perfil
               </a>
           </div>

           <!-- Loading Actions -->
           <div id="loadingActions" class="space-y-3">
               <div class="w-full bg-cosmic-700 rounded-lg h-12 animate-pulse"></div>
               <div class="w-full bg-cosmic-700 rounded-lg h-12 animate-pulse"></div>
           </div>
       </div>

       <!-- Help -->
       <div class="text-center">
           <p class="text-cosmic-400 text-sm">
               ¿Problemas con tu pago? 
               <a href="#" class="text-primary-400 hover:text-primary-300 transition-colors">
                   Contacta al soporte
               </a>
           </p>
       </div>
   </div>

   <!-- Floating Cosmic Elements -->
   <div class="fixed inset-0 pointer-events-none z-0">
       <div class="absolute top-1/4 left-1/4 w-2 h-2 bg-green-400 rounded-full animate-pulse opacity-60"></div>
       <div class="absolute top-1/3 right-1/3 w-1 h-1 bg-primary-400 rounded-full animate-ping"></div>
       <div class="absolute bottom-1/4 left-1/3 w-3 h-3 bg-gold-400 rounded-full animate-pulse opacity-40"></div>
       <div class="absolute top-2/3 right-1/4 w-2 h-2 bg-green-300 rounded-full animate-ping opacity-50"></div>
       <div class="absolute bottom-1/3 right-1/2 w-1 h-1 bg-primary-300 rounded-full animate-pulse opacity-70"></div>
   </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
   // ACTUALIZADO: Obtener parámetros de la URL
   const urlParams = new URLSearchParams(window.location.search);
   let paymentRef = urlParams.get('ref');
   const source = urlParams.get('source');
   const status = urlParams.get('status');
   
   console.log('Parámetros URL:', { paymentRef, source, status });
   
   if (!paymentRef) {
       showError('Referencia de pago no encontrada');
       return;
   }
   
   // Mostrar referencia en la UI
   document.getElementById('paymentRef').textContent = paymentRef;
   
   // NUEVO: Si viene de PayPal con estado completado, agregar parámetros a la verificación
   let verifyUrl = `/api/billing/verificar-pago/?ref=${paymentRef}`;
   if (source && status) {
       verifyUrl += `&source=${source}&status=${status}`;
   }
   
   // Verificar estado del pago
   verificarEstadoPago(verifyUrl);
});

// ACTUALIZADA: Función de verificación que acepta URL completa
function verificarEstadoPago(verifyUrl) {
   fetch(verifyUrl)
       .then(response => response.json())
       .then(data => {
           console.log('Respuesta de verificación:', data);
           
           if (data.success) {
               if (data.estado === 'completado') {
                   showSuccess(data);
               } else if (data.estado === 'pendiente') {
                   // ACTUALIZADO: Para enlaces directos de PayPal, reintentar más rápido
                   const urlParams = new URLSearchParams(window.location.search);
                   const source = urlParams.get('source');
                   
                   if (source === 'paypal') {
                       // Si viene de PayPal, reintentar en 2 segundos
                       setTimeout(() => verificarEstadoPago(verifyUrl), 2000);
                   } else {
                       // Otros métodos, reintentar en 3 segundos
                       setTimeout(() => verificarEstadoPago(verifyUrl), 3000);
                   }
               } else {
                   showError('El pago no fue completado exitosamente');
               }
           } else {
               showError(data.error || 'Error verificando el pago');
           }
       })
       .catch(error => {
           console.error('Error:', error);
           showError('Error de conexión');
       });
}

function showSuccess(data) {
   // Actualizar icono
   document.getElementById('processingIcon').className = 'fas fa-check text-3xl text-white';
   
   // Ocultar estado de procesamiento
   document.getElementById('processingState').classList.add('hidden');
   document.getElementById('successState').classList.remove('hidden');
   
   // Mostrar detalles
   document.getElementById('packageName').textContent = data.paquete_nombre;
   document.getElementById('creditsAmount').textContent = data.creditos_agregados;
   document.getElementById('paymentAmount').textContent = `$${data.monto}`;
   document.getElementById('paymentStatus').textContent = 'Completado';
   document.getElementById('paymentStatus').className = 'text-green-400';
   
   // Mostrar créditos
   document.getElementById('newCredits').textContent = data.creditos_agregados;
   document.getElementById('totalCredits').textContent = data.creditos_totales;
   document.getElementById('creditsDisplay').classList.remove('hidden');
   
   // Mostrar botones de acción
   document.getElementById('loadingActions').classList.add('hidden');
   document.getElementById('actionButtons').classList.remove('hidden');
   
   // Actualizar créditos en navbar si existe
   const navbarCreditos = document.querySelector('#creditos-display, #creditos-display-mobile');
   if (navbarCreditos) {
       navbarCreditos.textContent = data.creditos_totales;
   }
   
   // Animación de éxito
   setTimeout(() => {
       const checkIcon = document.getElementById('checkIcon');
       if (checkIcon) {
           checkIcon.style.transform = 'scale(1.2)';
           setTimeout(() => {
               checkIcon.style.transform = 'scale(1)';
           }, 200);
       }
   }, 500);
}

function showError(message) {
   document.getElementById('processingState').classList.add('hidden');
   document.getElementById('errorState').classList.remove('hidden');
   document.getElementById('errorMessage').textContent = message;
   document.getElementById('paymentStatus').textContent = 'Error';
   document.getElementById('paymentStatus').className = 'text-red-400';
   
   // Mostrar botón de reintentar
   document.getElementById('loadingActions').innerHTML = `
       <a href="{% url 'appWeb:comprar_creditos' %}" 
          class="block w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white text-center py-3 rounded-lg font-medium transition-all">
           <i class="fas fa-redo mr-2"></i>Intentar de Nuevo
       </a>
   `;
}
</script>
{% endblock %}
{% endblock %}