{% extends 'appWeb/base.html' %}
{% load static %}

{% block title %}Recuperar Contraseña - Tarotnaútica{% endblock %}

{% block content %}
<!-- VERSIÓN MÓVIL -->
<div class="md:hidden min-h-screen flex items-center justify-center bg-gradient-to-br from-cosmic-900 via-primary-900/30 to-mystic-900/30 py-8 px-4">
    <div class="w-full max-w-sm space-y-6">
        <!-- Logo y Header compacto -->
        <div class="text-center">
            <div class="flex items-center justify-center mb-6">
                <div class="w-12 h-12 rounded-full flex items-center justify-center shadow-2xl shadow-mystic-500/25 mr-3">
                    <i class="fas fa-key text-2xl text-mystic-400"></i>
                </div>
                <h2 class="font-mystical text-2xl font-bold text-cosmic-100">
                    Recuperar Clave
                </h2>
            </div>
            <p class="text-cosmic-300 text-sm leading-relaxed">
                Te enviaremos un enlace para restablecer tu contraseña
            </p>
        </div>

        <!-- Formulario compacto -->
        <div class="bg-cosmic-800/80 backdrop-blur-sm rounded-xl p-6 border border-cosmic-600 shadow-xl">
            <form method="post" class="space-y-4" id="resetForm">
                {% csrf_token %}

                <!-- Email Field -->
                <div class="space-y-2">
                    <label for="id_email" class="block text-sm font-medium text-cosmic-200">
                        <i class="fas fa-envelope mr-2 text-mystic-400"></i>
                        Email Registrado
                    </label>
                    <input type="email"
                           name="email"
                           id="id_email"
                           required
                           class="w-full px-4 py-3 bg-cosmic-800 border border-cosmic-600 rounded-lg focus:ring-2 focus:ring-mystic-500 focus:border-transparent text-cosmic-100 placeholder-cosmic-400"
                           placeholder="Tu email cósmico...">
                    <!-- Error container -->
                    <div id="email-error" class="text-red-400 text-sm hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span></span>
                    </div>
                </div>

                <!-- Info Box compacta -->
                <div class="bg-mystic-900/20 border border-mystic-500/30 rounded-lg p-3">
                    <div class="flex items-start space-x-2">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-mystic-400 mt-0.5 text-sm"></i>
                        </div>
                        <div class="text-xs text-cosmic-300">
                            <p class="font-medium text-mystic-300 mb-1">¿Cómo funciona?</p>
                            <div class="space-y-0.5">
                                <p>• Te enviaremos un enlace seguro</p>
                                <p>• El enlace expira en 1 hora</p>
                                <p>• Podrás crear una nueva contraseña</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        id="submitBtn"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-white bg-gradient-to-r from-mystic-500 to-gold-500 hover:from-mystic-600 hover:to-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-mystic-500 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl font-semibold">
                    <i class="fas fa-paper-plane mr-2" id="submitIcon"></i>
                    <span id="submitText">Enviar Enlace</span>
                </button>

                <!-- Loading State -->
                <div id="loadingState" class="hidden text-center">
                    <div class="inline-flex items-center text-mystic-400 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>Enviando...</span>
                    </div>
                </div>
            </form>

            <!-- Links de navegación -->
            <div class="text-center space-y-2 mt-6 pt-4 border-t border-cosmic-600">
                <p class="text-cosmic-300 text-sm">
                    ¿Recordaste tu contraseña?
                    <a href="{% url 'appWeb:login' %}"
                       class="font-medium text-primary-400 hover:text-primary-300 transition-colors">
                        Iniciar sesión
                    </a>
                </p>
                <p class="text-cosmic-400 text-xs">
                    ¿No tienes cuenta?
                    <a href="{% url 'appWeb:register' %}"
                       class="text-mystic-400 hover:text-mystic-300 transition-colors">
                        Únete al cosmos
                    </a>
                </p>
            </div>
        </div>

        <!-- Security Info compacto -->
        <div class="text-center">
            <p class="text-cosmic-400 text-xs">
                <i class="fas fa-shield-alt mr-1"></i>
                Protegido por cifrado cósmico
            </p>
        </div>
    </div>
</div>

<!-- VERSIÓN DESKTOP - Sin cambios -->
<div class="hidden md:block min-h-screen flex items-center justify-center bg-gradient-to-br from-cosmic-900 via-primary-900/30 to-mystic-900/30 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Logo y Header -->
        <div class="text-center">
            <div class="mx-auto h-16 w-16 flex items-center justify-center rounded-full bg-gradient-to-br from-mystic-500 to-gold-500 mb-6">
                <i class="fas fa-key text-2xl text-white"></i>
            </div>
            <h2 class="font-mystical text-3xl font-bold text-cosmic-100 mb-2">
                Recuperar tu Clave Mística
            </h2>
            <p class="text-cosmic-300 max-w-sm mx-auto">
                Ingresa tu email y te enviaremos un enlace para restablecer tu contraseña
            </p>
        </div>

        <!-- Formulario -->
        <div class="bg-cosmic-800/50 backdrop-blur-sm rounded-2xl p-8 border border-cosmic-600 shadow-xl">
            <form method="post" class="space-y-6" id="resetForm">
                {% csrf_token %}

                <!-- Email Field -->
                <div class="space-y-2">
                    <label for="id_email" class="block text-sm font-medium text-cosmic-200">
                        <i class="fas fa-envelope mr-2 text-mystic-400"></i>
                        Email Registrado
                    </label>
                    <input type="email"
                           name="email"
                           id="id_email"
                           required
                           class="w-full px-4 py-3 bg-cosmic-800 border border-cosmic-600 rounded-lg focus:ring-2 focus:ring-mystic-500 focus:border-transparent text-cosmic-100 placeholder-cosmic-400"
                           placeholder="Tu email cósmico...">
                    <!-- Error container -->
                    <div id="email-error" class="text-red-400 text-sm hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i>
                        <span></span>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-mystic-900/20 border border-mystic-500/30 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-mystic-400 mt-0.5"></i>
                        </div>
                        <div class="text-sm text-cosmic-300">
                            <p class="font-medium text-mystic-300 mb-1">¿Cómo funciona?</p>
                            <ul class="space-y-1 text-xs">
                                <li>• Te enviaremos un enlace seguro a tu email</li>
                                <li>• El enlace expira en 1 hora por seguridad</li>
                                <li>• Podrás crear una nueva contraseña</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                        id="submitBtn"
                        class="group relative w-full flex justify-center py-3 px-4 border border-transparent rounded-lg text-white bg-gradient-to-r from-mystic-500 to-gold-500 hover:from-mystic-600 hover:to-gold-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-mystic-500 transition-all duration-300 transform hover:scale-105 shadow-lg hover:shadow-xl">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <i class="fas fa-paper-plane text-mystic-200 group-hover:text-white transition-colors" id="submitIcon"></i>
                    </span>
                    <span class="font-semibold" id="submitText">Enviar Enlace de Recuperación</span>
                </button>

                <!-- Loading State -->
                <div id="loadingState" class="hidden text-center">
                    <div class="inline-flex items-center text-mystic-400">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        <span>Enviando enlace cósmico...</span>
                    </div>
                </div>
            </form>

            <!-- Divider -->
            <div class="my-8">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-cosmic-600"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-cosmic-800 text-cosmic-400">o</span>
                    </div>
                </div>
            </div>

            <!-- Back to Login -->
            <div class="text-center space-y-3">
                <p class="text-cosmic-300">
                    ¿Recordaste tu contraseña?
                    <a href="{% url 'appWeb:login' %}"
                       class="font-medium text-primary-400 hover:text-primary-300 transition-colors">
                        Volver al inicio de sesión
                    </a>
                </p>
                <p class="text-cosmic-400 text-sm">
                    ¿No tienes cuenta?
                    <a href="{% url 'appWeb:register' %}"
                       class="text-mystic-400 hover:text-mystic-300 transition-colors">
                        Únete al cosmos
                    </a>
                </p>
            </div>
        </div>

        <!-- Security Info -->
        <div class="text-center">
            <p class="text-cosmic-400 text-sm">
                <i class="fas fa-shield-alt mr-1"></i>
                Tu solicitud está protegida por cifrado cósmico de nivel empresarial
            </p>
        </div>
    </div>

    <!-- Floating Cosmic Elements -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-1/4 left-1/4 w-2 h-2 bg-mystic-400 rounded-full animate-pulse opacity-60"></div>
        <div class="absolute top-1/3 right-1/3 w-1 h-1 bg-gold-400 rounded-full animate-ping"></div>
        <div class="absolute bottom-1/4 left-1/3 w-3 h-3 bg-primary-400 rounded-full animate-pulse opacity-40"></div>
        <div class="absolute top-2/3 right-1/4 w-2 h-2 bg-mystic-300 rounded-full animate-ping opacity-50"></div>
        <div class="absolute bottom-1/3 right-1/2 w-1 h-1 bg-gold-300 rounded-full animate-pulse opacity-70"></div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitIcon = document.getElementById('submitIcon');
    const submitText = document.getElementById('submitText');
    const loadingState = document.getElementById('loadingState');
    const emailError = document.getElementById('email-error');

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Clear previous errors
        emailError.classList.add('hidden');

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        submitIcon.className = 'fas fa-spinner fa-spin text-mystic-200';
        submitText.textContent = 'Enviando...';
        loadingState.classList.remove('hidden');

        // Get form data
        const formData = new FormData(form);

        // Send request
        fetch('{% url "appWeb:password_reset" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to success page
                window.location.href = '{% url "appWeb:password_reset_sent" %}';
            } else {
                // Show error
                showError(data.error || 'Error al enviar el email. Inténtalo de nuevo.');
            }
        })
        .catch(error => {
            showError('Error de conexión. Verifica tu internet e inténtalo de nuevo.');
        })
        .finally(() => {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            submitIcon.className = 'fas fa-paper-plane text-mystic-200 group-hover:text-white transition-colors';
            submitText.textContent = window.innerWidth >= 768 ? 'Enviar Enlace de Recuperación' : 'Enviar Enlace';
            loadingState.classList.add('hidden');
        });
    });

    function showError(message) {
        emailError.querySelector('span').textContent = message;
        emailError.classList.remove('hidden');

        // Scroll to error
        emailError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Email validation
    const emailInput = document.getElementById('id_email');
    emailInput.addEventListener('blur', function() {
        const email = this.value.trim();
        if (email && !isValidEmail(email)) {
            showError('Por favor ingresa un email válido');
        } else {
            emailError.classList.add('hidden');
        }
    });

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
});
</script>
{% endblock %}
{% endblock %}